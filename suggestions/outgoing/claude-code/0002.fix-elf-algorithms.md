# Task: Fix validate-signature.pl ELF Implementation

**Priority**: HIGH  
**Assigned to**: claude-code (WSL)  
**Context**: documentation/ELF_ALGORITHM_CLARIFICATION.md  
**Status**: üìã Ready for implementation

---

## üéØ Objective

Fix `validate-signature.pl` to correctly implement AMOS ELF algorithms without BMW baked into the hash function.

---

## üìã Required Changes

### 1. Fix elf4_checksum (Line 14-28)
**Current**: Missing null byte handling  
**Add**:
```perl
my $char = ord($byte);
$char = 777 if $char == 0;  # CRITICAL: Handle null bytes
```

### 2. Rewrite elf7_checksum (Line 31-49)
**Current**: BMW pattern baked into algorithm ‚ùå  
**Required**: Complete rewrite to match AMOS ELF

**Remove**:
- BMW pattern (0b1011011) from algorithm
- All BMW XOR operations
- BMW from feedback loop
- BMW from final hash

**Add**:
- Null byte handling (777)
- Correct 7-bit left shift
- Correct 13-bit right shift feedback
- Fixed overflow threshold (0xFE000000)

### 3. Fix Comments Throughout
**Wrong terminology**:
- "4-bit checksum" ‚Üí "ELF-4 (4-bit shift per byte)"
- "7-bit checksum" ‚Üí "ELF-7 (7-bit shift per byte)"
- "7-bit BMW checksum" ‚Üí "ELF-7 (7-bit shift)"

**Update**:
- Line 13-14 (elf4 comment)
- Line 30-31 (elf7 comment)
- Line 250-251 (CLI help)
- POD documentation (lines 377-383)

---

## üîç Reference Implementation

Use this as template for both elf4 and elf7:

```perl
sub elf_checksum {
    my ($data, $left_shift) = @_;
    $left_shift //= 7;  # 4 for ELF-4, 7 for ELF-7
    
    my $hash = 0;
    my $right_shift = 13;              # FIXED
    my $overflow_mask = 0xFE000000;    # FIXED
    my $z_val = 777;                   # NULL byte value
    
    for my $byte (split //, $data) {
        my $char = ord($byte);
        $char = $z_val if $char == 0;  # Handle nulls
        
        $hash = ($hash << $left_shift) + $char;
        
        my $overflow = $hash & $overflow_mask;
        if ($overflow) {
            $hash ^= $overflow >> $right_shift;
        }
        $hash &= ~$overflow;
    }
    
    # Return hex format (match existing output format)
    return sprintf("%07x", $hash & 0x1FFFFFF);
}
```

---

## ‚úÖ Testing

After fixes, test with:

```bash
# Test signing
perl validate-signature.pl sign test_payload.txt test_signed.yaml elf7

# Test validation
perl validate-signature.pl validate test_signed.yaml

# Should output:
# ‚úì SIGNATURE VALID
```

---

## üìù After Implementation

1. **Re-sign all workspace command files**:
   - `workspace-resume.elf7.yaml`
   - `README.init.elf7.asc`
   - `README.resume.elf7.asc`

2. **Test validation**: Confirm all re-signed files validate correctly

3. **Commit changes**: Use descriptive commit message explaining the fix

4. **Push to remote**: Make available for next session

---

## üîó Reference Documents

- `documentation/ELF_ALGORITHM_CLARIFICATION.md` - Full architecture explanation
- `bin/amos-chksum` (amos-chksum repo) - Reference implementation
- `data/lib-path/pm/AMOS7/CHKSUM/ELF/Inline.pm` - C implementation

---

## ‚ö†Ô∏è Critical Points

1. **BMW is NOT part of ELF algorithm** - it's a separate system
2. **NULL bytes must add 777** - not 0 (that's a no-op)
3. **ELF mode = left shift amount** - not checksum bit width
4. **Overflow threshold is fixed** - 0xFE000000 (never change)

---

**Status**: üìã Documented and ready  
**Blocker**: None  
**ETA**: < 1 hour implementation

---

*"Separate concerns, preserve entropy, validate truth."*
